---
title: "Compare events against each other"
author: "Martin R. Smith"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    includes:
      in_header: ../inst/preamble.tex
  rmarkdown::html_document:

vignette: >
  %\VignetteIndexEntry{Comparison of different events}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{R Compare events}
courses <- c('riverside', 'durham', 'gibside')
require('parkrun')


courseResults <- lapply(courses, function (course) {
  eventHistory <- EventHistory(course)
  eventResults <- list.files(EventDirectory(course), pattern="\\d+", full.names=TRUE)
  suppressWarnings(dplyr::bind_rows(lapply(eventResults, read.table)))
})
results <- suppressWarnings(dplyr::bind_rows(courseResults))
results <- results[!is.na(results$athleteNumber), ]
results$runSeqNumber <- paste0(results$eventName, results$runSeqNumber)
results$eventName <- relevel(as.factor(results$eventName), ref=courses[1])

uniqueAthletes <- na.omit(unique(results$athleteNumber))
athletesAtEvent <- vapply(courseResults, function (x) uniqueAthletes %in% x$athleteNumber, logical(length(uniqueAthletes)))
tourists <- uniqueAthletes[rowSums(athletesAtEvent) > 1]

usefulResults <- results[results$athleteNumber %in% tourists, ]

outliers <- as.character(unlist(by(usefulResults, usefulResults$athleteNumber, function(x) {
  athleteSpeeds <- 5000 / x$timeInSeconds
  normalRange <- median(athleteSpeeds) + (sd(athleteSpeeds) * c(-4, +4))
  rownames(x)[athleteSpeeds < normalRange[1] | athleteSpeeds > normalRange[2]]
})))
usefulResults <- usefulResults[!rownames(usefulResults) %in% outliers, ]

athleteResults <- table(usefulResults$athleteNumber)
athleteEntries <- rev(table(athleteResults))

tooManyAthletes <- 500
minRuns <- names(athleteEntries[sum(cumsum(athleteEntries) < tooManyAthletes)])
usefulAthletes <- rownames(athleteResults)[athleteResults >= as.integer(minRuns)]
usefulResults <- usefulResults[usefulResults$athleteNumber %in% usefulAthletes, ]

# The passage of time makes no significant contribution
model <- lm(I(-5000 / usefulResults$timeInSeconds) ~ 
              usefulResults$eventName + as.factor(usefulResults$athleteNumber))
coefs <- summary(model)$coefficients

intercept <- coefs[1, 1]
exampleTimes <- c(17, 20, 22, 25, 28, 30, 35, 40) * 60
exampleSpeeds <- 5000 / exampleTimes
names(exampleSpeeds) <- SecondsToMinutes(exampleTimes)

eventCoefs <- rbind(coefs[1L + seq_along(courses[-1]), c(1, 2), drop=FALSE])
ret <- apply(eventCoefs, 1, function(x) {
  target <- 5000 / (exampleSpeeds - x[1])
  max <- 5000 / (exampleSpeeds - (x[1] + x[2]))
  min <- 5000 / (exampleSpeeds - (x[1] - x[2]))
  paste0(SecondsToMinutes(target), " Â± ", round(colMeans(rbind(target- min, max - target))), 's')
})

ret <- cbind(SecondsToMinutes(exampleTimes), ret)
eventSequence <- sub('.*eventName(.*)', '\\1', rownames(eventCoefs))
colnames(ret) <- c(courses[1], eventSequence)

# Return:
knitr::kable(ret)
```
